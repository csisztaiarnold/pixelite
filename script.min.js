$(document).ready(function(){function a(a){a.hasClass("active")?(w=!1,ditherBrushArray=[],a.removeClass("active")):(w=!0,ditherBrushArray=b,a.addClass("active"))}function t(a){return[Math.floor((a.clientX+container.scrollLeft)/d),Math.floor((a.clientY+container.scrollTop)/d)]}function e(a){return[Math.floor((a.clientX+container.scrollLeft)/d/8),Math.floor((a.clientY+container.scrollTop)/d/8)]}function o(a){var t=8*a[0],e=8*a[1];return function(a){var t,e=0,o=[];for(t=0;t<a.length;t++)t%4==0&&(o[e]=a[t]+","+a[t+1]+","+a[t+2]+","+a[t+3],e++);return uniqueItems=[],$.each(o,function(a,t){-1===$.inArray(t,uniqueItems)&&uniqueItems.push(t)}),uniqueItems}(l.getImageData(t,e,8,8).data)}function n(){s.getContext("2d").drawImage(i,0,0)}function c(a){var c=t(a),r=e(a),i=o(r),s=c[0]-8*r[0]+8*(c[1]-8*r[1]);if(m=3==a.which?f:m,i.length<2||m+",255"==i[0]||m+",255"==i[1]||0==p){if(1==w&&-1!=$.inArray(s,ditherBrushArray))return!1;!function(a,t,e){l.putImageData(v,a,t),l.fillStyle="rgba("+e+",1)",l.fillRect(a,t,1,1)}(c[0],c[1],m)}else!function(a,t,e){var o=8*a[0],n=8*a[1],c=l.getImageData(o,n,8,8),r=0,i=[];for(data=c.data,d=0;d<data.length;d++)d%4==0&&(i[r]=data[d]+","+data[d+1]+","+data[d+2]+","+data[d+3],r++);for(colorToChange=i[t],d=0;d<i.length;d++)i[d]==colorToChange&&(i[d]=m+",255");var s=[],r=0;$.each(i,function(a,t){var e=i[a].split(",");for(d=0;d<e.length;d++)s[r]=e[d],r++});for(var d=0;d<c.data.length;d++)c.data[d]=s[d];l.putImageData(c,o,n)}(r,s);m=$(".color-indicators .left-click").data("rgb"),f=$(".color-indicators .right-click").data("rgb"),n()}window.addEventListener("beforeunload",function(a){return a.returnValue="Are you sure you want to leave the page?","Are you sure you want to leave the page?"}),document.addEventListener("contextmenu",function(a){a.preventDefault()},!1),$("#preview-canvas-container, #palette-container, #options-container, #zoom").draggable({handle:"h1"});var r,i=document.getElementById("canvas"),s=document.getElementById("preview-canvas"),l=i.getContext("2d"),d=32,u=1,h=!1,v=l.createImageData(1,1),g=(v.data,!1),m="0,0,0",f="255,255,255",p=!0,w=!1,b=[1,3,5,7,8,10,12,14,17,19,21,23,24,26,28,30,33,35,37,39,40,42,44,46,49,51,53,55,56,58,60,62],y=0,x=[],z=320,k=200;$("#canvas").attr("width",z).attr("height",k),$("#preview-canvas").attr("width",z).attr("height",k),$("#canvas-resize").on("click",function(){if(confirm("Are you sure you want to resize the canvas? This can't be undone!")){var a=l.getImageData(0,0,z,k);l.save(),l.setTransform(1,0,0,1,0,0),l.clearRect(0,0,z,k),z=$("#canvas-size-x").val(),k=$("#canvas-size-y").val(),z%8!=0&&(z=8*Math.round(z/8)),k%8!=0&&(k=8*Math.round(k/8)),$("#canvas-size-x").val(z),$("#canvas-size-y").val(k),$("#canvas").attr("width",z).attr("height",k),$("#preview-canvas").attr("width",z).attr("height",k),l.fillStyle="rgba("+$(".left-click").data("rgb")+",1)",l.fillRect(0,0,z,k),l.restore(),n(),l.putImageData(a,0,0),n()}}),$("#brush_1").on("click",function(){a($("#brush_1"))}),document.onkeyup=function(t){66==t.which&&a($("#brush_1")),t.ctrlKey&&90==t.which&&(!function(){var a=y-1;imgData=x[a],l.putImageData(imgData,0,0),y>1&&(y-=1)}(),n())},$("#canvas").css("zoom",d).css("-moz-transform","scale("+d+")"),$("#preview-canvas").css("zoom",u).css("-moz-transform","scale("+u+")"),$("#hires-limit").on("change",function(){$(this).is(":checked")?(p=!0,$(".current-colors-container").show()):(p=!1,$(".current-colors-container").hide())}),$("#zoom-level, #zoom span").text(d),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")}),$(window).on("load",function(){$("#container").scrollLeft(($("#canvas").width()*d-$(window).width())/2),$("#container").scrollTop(($("#canvas").height()*d-$(window).height())/2)});var I=1,C="",D='<select id="palette-change">';for(var A in palette){var T;for(D+='<option value="palette_'+I+'">'+A+"</option>",C+='<div class="palette-table palette_'+I+(1==I?" active":"")+'">',T=0;T<palette[A].length;T++)C+='<div class="color'+(0==I?" active":"")+'" data-rgb="'+palette[A][T]+'" style="background-color: rgba('+palette[A][T]+',1)"></div>';C+="</div>",I++}D+="</select>",$("#palette-selector").append(D),$("#palette").append(C),$("#palette-change").on("change",function(){$(".palette-table").removeClass("active"),$("."+$(this).val()).addClass("active")});var B=new Image;B.src="demopic.png",B.onload=function(){l.drawImage(B,0,0),n()},$("#clear").on("click",function(){confirm("Are you sure you want to clear the canvas? This can't be undone!")&&(l.save(),l.setTransform(1,0,0,1,0,0),l.clearRect(0,0,z,k),l.fillStyle="rgba("+m+",1)",l.fillRect(0,0,z,k),l.restore(),n())}),$(i).bind({mousedown:function(a){r=l.getImageData(0,0,z,k),g=!0,c(a)},mousemove:function(a){var r=t(a);$("#coor-x").text(r[0]),$("#coor-y").text(r[1]);var i=e(a);$("#charcoor-x").text(i[0]+1),$("#charcoor-y").text(i[1]+1),$("#char-overlay").css("top",i[1]*d*8+"px").css("left",i[0]*d*8+"px").css("width",8*d-1+"px").css("height",8*d-1+"px");var s=o(i);1==s.length&&(s[1]=s[0]),$("#current-colors .color1").css("background-color","rgba("+s[0]+")"),$("#current-colors .color2").css("background-color","rgba("+s[1]+")"),g&&(c(a),n())},mouseup:function(a){!function(a){x[y]=a,y++}(r),g=!1}}),$(".zoom-option").on("click",function(a){$(this).hasClass("zoom-in")?zoomIndex=4:zoomIndex=4==d?0:-4,$("#canvas").css("zoom",d+zoomIndex).css("-moz-transform","scale("+(d+zoomIndex)+")"),d+=zoomIndex,$("#zoom-level, #zoom span").text(d);var t=e(a);$("#char-overlay").css("top",t[1]*d*8+"px").css("left",t[0]*d*8+"px").css("width",8*d-1+"px").css("height",8*d-1+"px"),d<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")}),$("#preview-canvas").on("click",function(){event.stopPropagation(),h=!0,$("#preview-canvas").addClass("active")}),$(window).click(function(){h=!1,$("#preview-canvas").removeClass("active")}),$("#preview-canvas").bind("mousewheel",function(a){var t=a.originalEvent.wheelDelta;u+t>1?($(this).css("zoom",u+.5).css("-moz-transform","scale("+(u+.5)+")"),u+=.5,$("#preview-canvas-container h1 span em").text(u)):($(this).css("zoom",1).css("-moz-transform","scale(1)"),u=1,$("#preview-canvas-container h1 span em").text(u))}),$("#palette .color").on("click",function(){m=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(".color-indicators .left-click").css("background-color","rgba("+m+",255)"),$(".color-indicators .left-click").data("rgb",m),$(this).addClass("active")}),$("#palette .color").mousedown(function(a){3==a.which&&(f=$(this).data("rgb"),$(".color-indicators .right-click").css("background-color","rgba("+f+",255)"),$(".color-indicators .right-click").data("rgb",f))}),$("#save-image").on("click",function(){var a=document.getElementById("canvas").toDataURL("image/png");window.open("about:blank","image from canvas").document.write("<img src='"+a+"' alt='from canvas'/>")})});