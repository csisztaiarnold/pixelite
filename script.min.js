$(document).ready(function(){function t(t){t.hasClass("active")?(b=!1,ditherBrushArray=[],t.removeClass("active")):(b=!0,ditherBrushArray=y,t.addClass("active"))}function a(){startX=Math.floor($("#container").scrollLeft()/h),startY=Math.floor($("#container").scrollTop()/h),endX=Math.floor($(window).width()/h)+startX,endY=Math.floor($(window).height()/h)+startY,$(".locator").css("top",startY*u+25).css("left",startX*u).css("width",(endX-startX)*u).css("height",(endY-startY)*u)}function e(t){return[Math.floor((t.clientX+container.scrollLeft)/h),Math.floor((t.clientY+container.scrollTop)/h)]}function o(t){return[Math.floor((t.clientX+container.scrollLeft)/h/8),Math.floor((t.clientY+container.scrollTop)/h/8)]}function n(t){var a=8*t[0],e=8*t[1];return function(t){var a,e=0,o=[];for(a=0;a<t.length;a++)a%4==0&&(o[e]=t[a]+","+t[a+1]+","+t[a+2]+","+t[a+3],e++);return uniqueItems=[],$.each(o,function(t,a){-1===$.inArray(a,uniqueItems)&&uniqueItems.push(a)}),uniqueItems}(d.getImageData(a,e,8,8).data)}function c(){l.getContext("2d").drawImage(s,0,0)}function r(t){var a=e(t),r=o(t),i=n(r),s=a[0]-8*r[0]+8*(a[1]-8*r[1]);if(m=3==t.which?p:m,i.length<2||m+",255"==i[0]||m+",255"==i[1]||0==w){if(1==b&&-1!=$.inArray(s,ditherBrushArray))return!1;!function(t,a,e){d.putImageData(g,t,a),d.fillStyle="rgba("+e+",1)",d.fillRect(t,a,1,1)}(a[0],a[1],m)}else!function(t,a,e){var o=8*t[0],n=8*t[1],c=d.getImageData(o,n,8,8),r=0,i=[];for(data=c.data,l=0;l<data.length;l++)l%4==0&&(i[r]=data[l]+","+data[l+1]+","+data[l+2]+","+data[l+3],r++);for(colorToChange=i[a],l=0;l<i.length;l++)i[l]==colorToChange&&(i[l]=m+",255");var s=[],r=0;$.each(i,function(t,a){var e=i[t].split(",");for(l=0;l<e.length;l++)s[r]=e[l],r++});for(var l=0;l<c.data.length;l++)c.data[l]=s[l];d.putImageData(c,o,n)}(r,s);m=$(".color-indicators .left-click").data("rgb"),p=$(".color-indicators .right-click").data("rgb"),c()}window.addEventListener("beforeunload",function(t){return t.returnValue="Are you sure you want to leave the page?","Are you sure you want to leave the page?"}),document.addEventListener("contextmenu",function(t){t.preventDefault()},!1),$("#preview-canvas-container, #palette-container, #options-container, #zoom").draggable({handle:"h1"});var i,s=document.getElementById("canvas"),l=document.getElementById("preview-canvas"),d=s.getContext("2d"),h=32,u=1,v=!1,g=d.createImageData(1,1),f=(g.data,!1),m="0,0,0",p="255,255,255",w=!0,b=!1,y=[1,3,5,7,8,10,12,14,17,19,21,23,24,26,28,30,33,35,37,39,40,42,44,46,49,51,53,55,56,58,60,62],x=0,z=[],k=320,I=200;$("#canvas").attr("width",k).attr("height",I),$("#preview-canvas").attr("width",k).attr("height",I),$("#canvas-resize").on("click",function(){if(confirm("Are you sure you want to resize the canvas? This can't be undone!")){var t=d.getImageData(0,0,k,I);d.save(),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,k,I),k=$("#canvas-size-x").val(),I=$("#canvas-size-y").val(),k%8!=0&&(k=8*Math.round(k/8)),I%8!=0&&(I=8*Math.round(I/8)),$("#canvas-size-x").val(k),$("#canvas-size-y").val(I),$("#canvas").attr("width",k).attr("height",I),$("#preview-canvas").attr("width",k).attr("height",I),d.fillStyle="rgba("+$(".left-click").data("rgb")+",1)",d.fillRect(0,0,k,I),d.restore(),c(),d.putImageData(t,0,0),c()}}),$("#brush_1").on("click",function(){t($("#brush_1"))}),document.onkeyup=function(a){66==a.which&&t($("#brush_1")),a.ctrlKey&&90==a.which&&(!function(){var t=x-1;imgData=z[t],d.putImageData(imgData,0,0),x>1&&(x-=1)}(),c())},$("#canvas").css("zoom",h).css("-moz-transform","scale("+h+")"),$("#preview-canvas").css("zoom",u).css("-moz-transform","scale("+u+")"),$("#hires-limit").on("change",function(){$(this).is(":checked")?(w=!0,$(".current-colors-container").show()):(w=!1,$(".current-colors-container").hide())}),$("#zoom-level, #zoom span").text(h),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")}),$(window).on("load",function(){$("#container").scrollLeft(($("#canvas").width()*h-$(window).width())/2),$("#container").scrollTop(($("#canvas").height()*h-$(window).height())/2)});var C=1,D="",M='<select id="palette-change">';for(var T in palette){var A;for(M+='<option value="palette_'+C+'">'+T+"</option>",D+='<div class="palette-table palette_'+C+(1==C?" active":"")+'">',A=0;A<palette[T].length;A++)D+='<div class="color'+(0==C?" active":"")+'" data-rgb="'+palette[T][A]+'" style="background-color: rgba('+palette[T][A]+',1)"></div>';D+="</div>",C++}M+="</select>",$("#palette-selector").append(M),$("#palette").append(D),$("#palette-change").on("change",function(){$(".palette-table").removeClass("active"),$("."+$(this).val()).addClass("active")});var X=new Image;X.src="demopic.png",X.onload=function(){d.drawImage(X,0,0),c()},$("#clear").on("click",function(){confirm("Are you sure you want to clear the canvas? This can't be undone!")&&(d.save(),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,k,I),d.fillStyle="rgba("+m+",1)",d.fillRect(0,0,k,I),d.restore(),c())}),$(window).on("load resize",function(){a()}),$("#container").on("scroll",function(){a()}),$(s).bind({mousedown:function(t){i=d.getImageData(0,0,k,I),f=!0,r(t)},mousemove:function(t){var a=e(t);$("#coor-x").text(a[0]),$("#coor-y").text(a[1]);var i=o(t);$("#charcoor-x").text(i[0]+1),$("#charcoor-y").text(i[1]+1),$("#char-overlay").css("top",i[1]*h*8+"px").css("left",i[0]*h*8+"px").css("width",8*h-1+"px").css("height",8*h-1+"px");var s=n(i);1==s.length&&(s[1]=s[0]),$("#current-colors .color1").css("background-color","rgba("+s[0]+")"),$("#current-colors .color2").css("background-color","rgba("+s[1]+")"),f&&(r(t),c())},mouseup:function(t){!function(t){z[x]=t,x++}(i),f=!1}}),$(".zoom-option").on("click",function(t){$(this).hasClass("zoom-in")?zoomIndex=4:zoomIndex=4==h?0:-4,$("#canvas").css("zoom",h+zoomIndex).css("-moz-transform","scale("+(h+zoomIndex)+")"),h+=zoomIndex,$("#zoom-level, #zoom span").text(h);var a=o(t);$("#char-overlay").css("top",a[1]*h*8+"px").css("left",a[0]*h*8+"px").css("width",8*h-1+"px").css("height",8*h-1+"px"),h<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")}),$("#preview-canvas").on("click",function(){event.stopPropagation(),v=!0,$("#preview-canvas").addClass("active")}),$(window).click(function(){v=!1,$("#preview-canvas").removeClass("active")}),$("#preview-canvas").bind("mousewheel",function(t){var e=t.originalEvent.wheelDelta;u+e>1?($(this).css("zoom",u+.5).css("-moz-transform","scale("+(u+.5)+")"),u+=.5,$("#preview-canvas-container h1 span em").text(u)):($(this).css("zoom",1).css("-moz-transform","scale(1)"),u=1,$("#preview-canvas-container h1 span em").text(u)),a()}),$("#palette .color").on("click",function(){m=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(".color-indicators .left-click").css("background-color","rgba("+m+",255)"),$(".color-indicators .left-click").data("rgb",m),$(this).addClass("active")}),$("#palette .color").mousedown(function(t){3==t.which&&(p=$(this).data("rgb"),$(".color-indicators .right-click").css("background-color","rgba("+p+",255)"),$(".color-indicators .right-click").data("rgb",p))}),$("#save-image").on("click",function(){var t=document.getElementById("canvas").toDataURL("image/png");window.open("about:blank","image from canvas").document.write("<img src='"+t+"' alt='from canvas'/>")})});